import cocotb
import os
from pathlib import Path
from cocotb.triggers import Timer
import pickle


async def save_results(ret_val):
    proj_path = Path(__file__).resolve().parent
    results_dir = proj_path / "results"
    results_dir.mkdir(exist_ok=True)

    results_file = results_dir / "results.pickle"
    with open(results_file, "wb") as handle:
        pickle.dump(ret_val, handle, protocol=pickle.HIGHEST_PROTOCOL)


@cocotb.test()
async def tb_test(dut):
    # Drive DUT inputs from Jinja-generated constants
{% for arg in in_args %}
    dut.{{ arg[0] }}.value = {{ arg[1] }}
{% endfor %}

    # Debug: show which stimulus is active for this run
    dut._log.info(
        "Stimulus: {% for arg in in_args -%}{{ arg[0] }}={{ arg[1] }}{% if not loop.last %}, {% endif %}{%- endfor %}"
    )

    # Wait for combinational logic to settle
    await Timer(10, unit="ns")

    # Capture DUT outputs
    return_val = {
    {% for arg in out_args %}
        "{{ arg }}": int(dut.{{ arg }}.value),
    {% endfor %}
    }

    await save_results(return_val)
